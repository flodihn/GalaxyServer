<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/Volumes/Work/Projects/GalaxyServer/battle_srv/.eunit/battle_srv.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /Volumes/Work/Projects/GalaxyServer/battle_srv/.eunit/battle_srv.erl by COVER 2018-08-01 at 09:05:49

****************************************************************************

        |  -module(battle_srv).
        |  -behaviour(gen_server).
        |  
        |  -include("../galaxy_srv/include/galaxy_defs.hrl").
        |  -include("../faction_srv/include/faction_defs.hrl").
        |  -include("../resource_srv/include/resource_defs.hrl").
        |  -include("battle_defs.hrl").
        |  
        |  -define(SERVER, ?MODULE).
        |  
        |  -ifdef(TEST).
        |  -compile(export_all).
        |  -endif.
        |  
        |  %% ------------------------------------------------------------------
        |  %% API Function Exports
        |  %% ------------------------------------------------------------------
        |  
        |  -export([start_link/1]).
        |  
        |  %% ------------------------------------------------------------------
        |  %% gen_server Function Exports
        |  %% ------------------------------------------------------------------
        |  
        |  -export([init/1, handle_call/3, handle_cast/2, handle_info/2,
        |           terminate/2, code_change/3]).
        |  
        |  -export([
        |      create_force/4,
        |  	destroy_force/2,
        |  	add_resource_to_force/3,
        |  	add_resources_to_force/3,
        |  
        |      add_force_class/3,
        |      remove_force_class/2,
        |  
        |      add_force_model/5,
        |      remove_force_model/2,
        |  
        |      add_weapon_type/6,
        |      remove_weapon_type/2
        |      ]).
        |  
        |  -record(state, {implmod, implstate}).
        |  
        |  %% ------------------------------------------------------------------
        |  %% gen_server API Function Definitions
        |  %% ------------------------------------------------------------------
        |  
        |  start_link(ImplMod) -&gt;
<font color=red>     0..|      gen_server:start_link({local, ?SERVER}, ?MODULE, [ImplMod], []).</font>
        |  
        |  %% ------------------------------------------------------------------
        |  %% Battle Server API Function Definitions
        |  %% ------------------------------------------------------------------
        |  create_force(GalaxyId, DisplayName, Faction, FactionGroup) -&gt;
<font color=red>     0..|      gen_server:call(?SERVER, {create_force, GalaxyId, DisplayName,</font>
        |                               Faction, FactionGroup}).
        |  
        |  destroy_force(Id, GalaxyId) -&gt;
<font color=red>     0..|      gen_server:call(?SERVER, {destroy_force, Id, GalaxyId}).</font>
        |  
        |  add_resource_to_force(Name, GalaxyId, Resource) -&gt;
<font color=red>     0..|      gen_server:call(?SERVER, {add_resource_to_force, Name, GalaxyId,</font>
        |  		Resource}).
        |  
        |  add_resources_to_force(Name, GalaxyId, Resources) -&gt;
<font color=red>     0..|      gen_server:call(?SERVER, {add_resources_to_force, Name, GalaxyId,</font>
        |  		Resources}).
        |  
        |  add_force_class(Name, GalaxyId, DisplayName) -&gt;
<font color=red>     0..|      gen_server:call(?SERVER, {add_force_class, Name, GalaxyId,</font>
        |                                DisplayName}).
        |  
        |  remove_force_class(Name, GalaxyId) -&gt;
<font color=red>     0..|      gen_server:call(?SERVER, {remove_force_class, Name, GalaxyId}).</font>
        |  
        |  add_force_model(Name, GalaxyId, DisplayName, Class, Weapons) -&gt;
<font color=red>     0..|      gen_server:call(?SERVER, {add_force_model, Name, GalaxyId,</font>
        |                                DisplayName, Class, Weapons}).
        |  
        |  remove_force_model(Name, GalaxyId) -&gt;
<font color=red>     0..|      gen_server:call(?SERVER, {remove_force_model, Name, GalaxyId}).</font>
        |  
        |  add_weapon_type(Name, GalaxyId, DisplayName, StrongVs, WeakVs,
        |                 BaseStrength) -&gt;
<font color=red>     0..|      case {validate_numeric_proplist(StrongVs),</font>
        |              validate_numeric_proplist(StrongVs)} of
<font color=red>     0..|          {false, _} -&gt; {error, strong_vs_not_numeric_proplist};</font>
<font color=red>     0..|          {_, false} -&gt; {error, weak_vs_not_numeric_proplist};</font>
        |          {true, true} -&gt;
<font color=red>     0..|              gen_server:call(?SERVER, {add_weapon_type, Name, GalaxyId,</font>
        |  		        DisplayName, StrongVs, WeakVs, BaseStrength})
        |      end.           
        |  
        |  remove_weapon_type(Name, GalaxyId) -&gt;
<font color=red>     0..|      gen_server:call(?SERVER, {remove_weapon_type, Name, GalaxyId}).</font>
        |  
        |  %% ------------------------------------------------------------------
        |  %% gen_server Function Definitions
        |  %% ------------------------------------------------------------------
        |  
        |  init([ImplMod]) -&gt;
<font color=red>     0..|      State = ImplMod:init(),</font>
<font color=red>     0..|      {ok, #state{implmod = ImplMod, implstate = State}}.</font>
        |  
        |  handle_call({create_force, GalaxyId, DisplayName, Faction,
        |               FactionGroup}, _From, #state{implmod = ImplMod,
        |               implstate = ImplState} = State) -&gt;
<font color=red>     0..|      Id = uuid:generate(),</font>
<font color=red>     0..|      case ImplMod:force_exists(Id, GalaxyId, ImplState) of</font>
        |          true -&gt;
<font color=red>     0..|              {reply, {error, force_id_exists}, State};</font>
        |          false  -&gt;
<font color=red>     0..|              Force = #force{</font>
        |                  id = Id,
        |                  galaxy_id = GalaxyId,
        |                  display_name = DisplayName,
        |                  faction = Faction,
        |                  faction_group = FactionGroup},
<font color=red>     0..|              ImplMod:create_force(Force, ImplState),</font>
<font color=red>     0..|              {reply, {ok, Id}, State}</font>
        |      end;
        |  
        |  handle_call({destroy_force, Id, GalaxyId}, _From,
        |              #state{implmod = ImplMod, implstate = ImplState} = State) -&gt;
<font color=red>     0..|      case ImplMod:force_exists(Id, GalaxyId, ImplState) of</font>
        |          false -&gt;
<font color=red>     0..|              {reply, {error, not_found}, State};</font>
        |          true -&gt;
<font color=red>     0..|              ImplMod:destroy_force(Id, GalaxyId, ImplState),</font>
<font color=red>     0..|              {reply, {ok, force_destroyed}, State}</font>
        |      end;
        |  
        |  handle_call({add_force_class, Name, GalaxyId, DisplayName}, _From,
        |              #state{implmod = ImplMod, implstate = ImplState} = State) -&gt;
<font color=red>     0..|      case ImplMod:force_class_exists(Name, GalaxyId, ImplState) of</font>
        |          true -&gt;
<font color=red>     0..|              {reply, {error, force_class_exists}, State};</font>
        |          false  -&gt;
<font color=red>     0..|              ForceClass= #force_class{</font>
        |                  name = Name,
        |                  galaxy_id = GalaxyId,
        |                  display_name = DisplayName},
<font color=red>     0..|              ImplMod:add_force_class(ForceClass, ImplState),</font>
<font color=red>     0..|              {reply, {ok, force_class_added}, State}</font>
        |      end;
        |  
        |  handle_call({remove_force_class, Name, GalaxyId}, _From, #state{
        |              implmod = ImplMod, implstate = ImplState} = State) -&gt;
<font color=red>     0..|      case ImplMod:force_class_exists(Name, GalaxyId, ImplState) of</font>
        |          true -&gt;
<font color=red>     0..|              {ok, force_class_removed} = ImplMod:remove_force_class(</font>
        |                                            Name, GalaxyId, ImplState),
<font color=red>     0..|                  {reply, {ok, force_class_removed}, State};</font>
        |          false -&gt;
<font color=red>     0..|                  {reply, {error, force_class_not_found}, State}</font>
        |      end;
        |  
        |  handle_call({add_force_model, Name, GalaxyId, DisplayName, Class,
        |               Weapons}, _From, #state{implmod = ImplMod,
        |                                       implstate = ImplState} = State) -&gt;
<font color=red>     0..|      OnlyWeaponTypes = [element(1, Weapon) || Weapon &lt;- Weapons],</font>
<font color=red>     0..|      case {ImplMod:force_model_exists(Name, GalaxyId, ImplState),</font>
        |            ImplMod:force_class_exists(Class, GalaxyId, ImplState),
        |            verify_all_weapon_types_exists(OnlyWeaponTypes, GalaxyId, ImplMod,
        |                                            ImplState)} of
        |          {true,_,  _} -&gt;
<font color=red>     0..|              {reply, {error, force_model_exists}, State};</font>
        |          {_, _, {error, NonExistingWeaponTypes}} -&gt;
<font color=red>     0..|              {reply, {error, {non_existing_weapon_types,</font>
        |                               NonExistingWeaponTypes}}, State};
        |          {_, false, _} -&gt;
<font color=red>     0..|              {reply, {error, non_existing_force_class}, State};</font>
        |          {false, true, ok} -&gt;
<font color=red>     0..|              ForceClass= #force_model{</font>
        |                  name = Name,
        |                  galaxy_id = GalaxyId,
        |                  display_name = DisplayName,
        |                  class = Class,
        |                  weapons = Weapons},
<font color=red>     0..|              ImplMod:add_force_model(ForceClass, ImplState),</font>
<font color=red>     0..|              {reply, {ok, force_model_added}, State}</font>
        |      end;
        |  
        |  handle_call({remove_force_model, Name, GalaxyId}, _From, #state{
        |              implmod = ImplMod, implstate = ImplState} = State) -&gt;
<font color=red>     0..|      case ImplMod:force_model_exists(Name, GalaxyId, ImplState) of</font>
        |          true -&gt;
<font color=red>     0..|              {ok, force_model_removed} = ImplMod:remove_force_model(</font>
        |                                            Name, GalaxyId, ImplState),
<font color=red>     0..|                  {reply, {ok, force_model_removed}, State};</font>
        |          false -&gt;
<font color=red>     0..|                  {reply, {error, force_model_not_found}, State}</font>
        |      end;
        |  
        |  handle_call({add_weapon_type, Name, GalaxyId, DisplayName, StrongVs, 
        |               WeakVs, BaseStrength}, _From, #state{implmod = ImplMod, 
        |               implstate = ImplState} = State) -&gt;
        |  
<font color=red>     0..|      case {ImplMod:weapon_type_exists(Name, GalaxyId, ImplState),</font>
        |            verify_all_force_models_exists(StrongVs, GalaxyId, ImplMod,
        |                                            ImplState),
        |            verify_all_force_models_exists(WeakVs, GalaxyId, ImplMod,
        |                                            ImplState)} of
        |          {true, _, _} -&gt;
<font color=red>     0..|              {reply, {error, weapon_type_already_exists}, State};</font>
        |          {_, {missing_force_models, WrongWeakVsForceClasses}, _} -&gt;
<font color=red>     0..|              {reply, {error, {non_existing_force_models,</font>
        |                               WrongWeakVsForceClasses}}, State};
        |          {_, _, {missing_force_models, WrongStrongVsForceClasses}} -&gt;
<font color=red>     0..|              {reply, {error, {non_existing_force_models,</font>
        |                               WrongStrongVsForceClasses}}, State};
        |          {false, ok, ok} -&gt;
<font color=red>     0..|              WeaponType = #weapon_type{</font>
        |                  name = Name,
        |                  galaxy_id = GalaxyId,
        |                  display_name = DisplayName,
        |                  strong_vs = StrongVs,
        |                  weak_vs = WeakVs,
        |                  base_strength = BaseStrength},
<font color=red>     0..|              ImplMod:add_weapon_type(WeaponType, ImplState),</font>
<font color=red>     0..|              {reply, {ok, weapon_type_added}, State}</font>
        |      end;
        |  
        |  handle_call({remove_weapon_type, Name, GalaxyId}, _From, #state{
        |              implmod = ImplMod, implstate = ImplState} = State) -&gt;
<font color=red>     0..|      case ImplMod:weapon_type_exists(Name, GalaxyId, ImplState) of</font>
        |          true -&gt;
<font color=red>     0..|              {ok, weapon_type_removed} = ImplMod:remove_weapon_type(</font>
        |                                            Name, GalaxyId, ImplState),
<font color=red>     0..|                  {reply, {ok, weapon_type_removed}, State};</font>
        |          false -&gt;
<font color=red>     0..|                  {reply, {error, weapon_type_not_found}, State}</font>
        |      end;
        |  
        |  handle_call(Request, _From, State) -&gt;
<font color=red>     0..|      error_logger:info_report({unknown_request, Request}),</font>
<font color=red>     0..|      {reply, {error, unknown_request}, State}.</font>
        |  
        |  handle_cast(_Msg, State) -&gt;
<font color=red>     0..|      {noreply, State}.</font>
        |  
        |  handle_info(_Info, State) -&gt;
<font color=red>     0..|      {noreply, State}.</font>
        |  
        |  terminate(_Reason, _State) -&gt;
<font color=red>     0..|  	ok.</font>
        |  
        |  code_change(_OldVsn, State, _Extra) -&gt;
<font color=red>     0..|      {nopreply, State}.</font>
        |  
        |  verify_all_weapon_types_exists(List, GalaxyId, ImplMod, ImplState) -&gt;
<font color=red>     0..|      {ok, AllWeaponTypes} = ImplMod:get_weapon_types(GalaxyId, ImplState),</font>
<font color=red>     0..|      ResultList = [lists:member(WeaponType, AllWeaponTypes) ||</font>
<font color=red>     0..|          WeaponType &lt;- List],</font>
<font color=red>     0..|      case proplists:lookup_all(error, ResultList) of</font>
        |          [] -&gt;
<font color=red>     0..|              ok;</font>
        |          ErrorList -&gt;
<font color=red>     0..|              OnlyNonExistingWeaponTypes = [element(1, F) || F &lt;- ErrorList],</font>
<font color=red>     0..|              {missing_weapon_types, OnlyNonExistingWeaponTypes}</font>
        |      end.
        |  
        |  validate_numeric_proplist([]) -&gt;
<font color=red>     0..|      true;</font>
        |  
        |  validate_numeric_proplist([{Key, Value} | List]) when 
        |          is_binary(Key), is_number(Value) -&gt;
<font color=red>     0..|      validate_numeric_proplist(List);</font>
        |  
        |  validate_numeric_proplist(_NoMatch) -&gt;
<font color=red>     0..|      false.</font>
        |  
        |  verify_all_force_models_exists(List, GalaxyId, ImplMod, ImplState) -&gt;
<font color=red>     0..|      {ok, AllForceClasses} = ImplMod:get_force_models(GalaxyId, ImplState),</font>
<font color=red>     0..|      OnlyAllForceClassNames = [element(1, ForceClass) ||</font>
<font color=red>     0..|          ForceClass &lt;- AllForceClasses],</font>
<font color=red>     0..|      ResultList = [lists:member(ForceClass, OnlyAllForceClassNames) ||</font>
<font color=red>     0..|          ForceClass &lt;- List],</font>
<font color=red>     0..|      case proplists:lookup_all(error, ResultList) of</font>
        |          [] -&gt;
<font color=red>     0..|              ok;</font>
        |          ErrorList -&gt;
<font color=red>     0..|              OnlyNonExistingForceClasses = [element(1, F) || </font>
<font color=red>     0..|                                             F &lt;- ErrorList],</font>
<font color=red>     0..|              {missing_force_models, OnlyNonExistingForceClasses}</font>
        |      end.
        |  
        |  calculate_force_capabilities(#force{resources = Resources,
        |                                     galaxy_id = GalaxyId} = Force,
        |                              ImplMod, ImplState) -&gt;
     1..|      CapabilityDict = dict:new(),
     1..|      AllMilitaryResources = filter_force_model_resources(Resources,
        |                                                         GalaxyId),
        |  
     1..|      {ok, UpdatedCapabilityDict} = process_resource_capabilities(
        |                                AllMilitaryResources,
        |                                CapabilityDict,
        |                                ImplMod,
        |                                ImplState),
     1..|      {ok, Force#force{capabilities = dict:to_list(
        |                                        UpdatedCapabilityDict)}}.
        |      
        |  process_resource_capabilities([], CapabilitiesDict, _ImplMod,
        |                                _ImplState) -&gt;
     1..|      {ok, CapabilitiesDict};
        |  
        |  process_resource_capabilities([MilitaryResource | Resouces],
        |                                CapabilitiesDict, ImplMod, ImplState) -&gt;
     1..|      ResourceName = MilitaryResource#resource.name,
     1..|      GalaxyId = MilitaryResource#resource.galaxy_id,
     1..|      ResourceAmount = MilitaryResource#resource.amount,
     1..|      {ok, UpdatedCapabilitiesDict} = process_weapons_capabilities(ResourceName,
        |                                                       GalaxyId,
        |                                                       ResourceAmount,
        |                                                       CapabilitiesDict,
        |                                                       ImplMod,
        |                                                       ImplState),
     1..|      process_resource_capabilities(Resouces, UpdatedCapabilitiesDict,
        |                                     ImplMod, ImplState).
        |  
        |  process_weapons_capabilities(ResourceName, GalaxyId, ResourceAmount,
        |                               Dict, ImplMod, ImplState) -&gt;
     1..|      {ok, ResourceType} = resource_srv:get_resource_type(
        |                             ResourceName, GalaxyId),
     1..|      ForceClass = ResourceType#resource_type.type,
        |      %% Weapons is proplist containg the weapon type and the number of
        |      %% weapons, example: {&lt;&lt;"laser_turret"&gt;&gt;, 6}. 
     1..|      Weapons = ForceClass#force_model.weapons,
     1..|      {ok, UpdatedDict} = update_weapons_capabilities(
        |                            Weapons, Dict, ResourceAmount, GalaxyId,
        |                            ImplMod, ImplState),
     1..|      {ok, UpdatedDict}.
        |  
        |  update_weapons_capabilities([], Dict, _ResourceAmount, _GalaxyId,
        |                              _ImplMod, _ImplState) -&gt;
     1..|      {ok, Dict};
        |  
        |  update_weapons_capabilities([Weapon| Weapons], Dict, ResourceAmount,
        |                              GalaxyId, ImplMod, ImplState) -&gt;
     1..|      {WeaponName, NumWeapons} = Weapon,
     1..|      {ok, WeaponType} = ImplMod:get_weapon_type(WeaponName, GalaxyId,
        |                                           ImplState),
     1..|      Capabilties = WeaponType#weapon_type.strong_vs,
     1..|      {ok, UpdatedDict} = add_capabilitites_to_dict(Capabilties,
        |                                                    ResourceAmount,
        |                                                    NumWeapons, Dict),
     1..|      update_weapons_capabilities(Weapons, UpdatedDict, ResourceAmount,
        |                                  GalaxyId, ImplMod, ImplState).
        |  
        |  add_capabilitites_to_dict([], _NumWeapons, _ResouceAmount, Dict) -&gt;
     1..|      {ok, Dict};
        |  
        |  add_capabilitites_to_dict([{Capability, Strength} | Capabilties],
        |                            NumWeapons, ResourceAmount, Dict) -&gt;
     3..|      UpdatedDict = dict:update_counter(
        |                      Capability,
        |                      Strength * NumWeapons * ResourceAmount,
        |                      Dict),
     3..|      add_capabilitites_to_dict(Capabilties, NumWeapons, ResourceAmount,
        |                                UpdatedDict).
        |  
        |  filter_force_model_resources(Resources, GalaxyId) -&gt;
     1..|      ResourceNames = [Resource#resource.name || Resource &lt;- Resources],
     1..|      {ok, ResourceTypes} = resource_srv:get_resource_types(
        |                                ResourceNames, GalaxyId),
     1..|      ZippedList = lists:zip(Resources, ResourceTypes),
     1..|      [Resource || {Resource, ResourceType} &lt;- ZippedList,
     1..|          element(1, ResourceType#resource_type.type) == force_model].
</pre>
</body>
</html>
