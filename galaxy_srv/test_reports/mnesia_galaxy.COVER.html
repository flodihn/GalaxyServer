<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/Volumes/Work/Projects/GalaxyServer/galaxy_srv/.eunit/mnesia_galaxy.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /Volumes/Work/Projects/GalaxyServer/galaxy_srv/.eunit/mnesia_galaxy.erl by COVER 2018-05-27 at 20:08:50

****************************************************************************

        |  -module(mnesia_galaxy).
        |  
        |  -define(DB_GALAXY_TABLE, galaxies).
        |  -define(DB_RESOURCE_TYPE_TABLE, resource_types).
        |  -define(DB_STRUCTURE_TYPE_TABLE, structure_types).
        |  
        |  -include("galaxy_defs.hrl").
        |  -include("resource_defs.hrl").
        |  
        |  -export([
        |      init/0
        |      ]).
        |  
        |  -export([
        |      create_galaxy/2,
        |      update_galaxy/2,
        |  	destroy_galaxy/2,
        |      get_galaxies/1,
        |  	get_galaxy/2,
        |      create_region/2,
        |      get_regions/2,
        |      get_region/3,
        |      add_region_to_galaxy_record/3,
        |      system_exists/3,
        |      create_system/2,
        |      get_systems/2,
        |      get_system/3,
        |  	remove_system/3,
        |  	connect_system/4,
        |  	disconnect_system/4,
        |      create_planet/2,
        |      get_planet/3,
        |      update_planet/2,
        |      create_resource_type/2,
        |      create_structure_type/2,
        |      get_resource_type/2,
        |      get_structure_type/2,
        |      get_resource/5,
        |      add_resource/5,
        |      add_structure/5,
        |  	consistency_fix/1,
        |  	create_galaxy_tables/1
        |      ]).
        |  
        |  init() -&gt;
<font color=red>     0..|      mnesia:start(),</font>
<font color=red>     0..|      GalaxyAttributes = record_info(fields, galaxy),</font>
<font color=red>     0..|      create_table(?DB_GALAXY_TABLE, galaxy, GalaxyAttributes, [], set),</font>
        |      
<font color=red>     0..|      ResourceTypeAttributes = record_info(fields, resource_type),</font>
<font color=red>     0..|      create_table(?DB_RESOURCE_TYPE_TABLE, resource_type,</font>
        |          ResourceTypeAttributes, [category], set),
        |  
<font color=red>     0..|      StructureTypeAttributes = record_info(fields, structure_type),</font>
<font color=red>     0..|      create_table(?DB_STRUCTURE_TYPE_TABLE, structure_type,</font>
        |          StructureTypeAttributes, [category], set),
        |   
<font color=red>     0..|      {ok, []}.</font>
        |  
        |  create_galaxy_tables(GalaxyId) -&gt;
<font color=red>     0..|      RegionsTable = get_regions_table(GalaxyId),</font>
<font color=red>     0..|      RegionAttributes = record_info(fields, region),</font>
<font color=red>     0..|      create_table(RegionsTable, region, RegionAttributes, [galaxy_id], set),</font>
        |  
<font color=red>     0..|      SystemsTable = get_systems_table(GalaxyId),</font>
<font color=red>     0..|      SystemAttributes = record_info(fields, system),</font>
<font color=red>     0..|      create_table(SystemsTable, system, SystemAttributes, [galaxy_id], set),</font>
        |  
<font color=red>     0..|      PlanetsTable = get_planets_table(GalaxyId),</font>
<font color=red>     0..|      PlanetsAttributes = record_info(fields, planet),</font>
<font color=red>     0..|      create_table(PlanetsTable, planet, PlanetsAttributes, [galaxy_id], set).</font>
        |  
        |  destroy_galaxy_tables(GalaxyId) -&gt;
<font color=red>     0..|      RegionsTable = get_regions_table(GalaxyId),</font>
<font color=red>     0..|      mnesia:delete_table(RegionsTable),</font>
        |  
<font color=red>     0..|      SystemsTable = get_systems_table(GalaxyId),</font>
<font color=red>     0..|      mnesia:delete_table(SystemsTable),</font>
        |  
<font color=red>     0..|      PlanetsTable = get_planets_table(GalaxyId),</font>
<font color=red>     0..|      mnesia:delete_table(PlanetsTable).</font>
        |  
        |  create_table(TableName, RecordName, Attributes, IndexList, Type) -&gt;
<font color=red>     0..|      case lists:member(TableName, mnesia:system_info(tables)) of</font>
        |          true -&gt;
<font color=red>     0..|              {ok, already_exists};</font>
        |          false -&gt;
<font color=red>     0..|              change_to_disc_schema(),</font>
<font color=red>     0..|              mnesia:create_table(TableName, </font>
        |                  [
        |                      {record_name, RecordName},
        |                      {disc_copies, [node()]},
        |                      {type, Type},
        |                      {attributes, Attributes}
        |                  ]),
<font color=red>     0..|              ok = create_indexes(TableName, IndexList),</font>
<font color=red>     0..|              {ok, created}</font>
        |      end.
        |  
        |  create_indexes(_TableName, []) -&gt;
<font color=red>     0..|      ok;</font>
        |  
        |  create_indexes(TableName, [Field | Rest]) -&gt;
<font color=red>     0..|      mnesia:add_table_index(TableName, Field),</font>
<font color=red>     0..|      create_indexes(TableName, Rest).</font>
        |  
        |  change_to_disc_schema() -&gt;
<font color=red>     0..|      mnesia:change_config(extra_db_nodes, [node()]),</font>
<font color=red>     0..|      mnesia:change_table_copy_type(schema, node(), disc_copies).</font>
        |  
        |  consistency_fix(GalaxyId) -&gt;
<font color=red>     0..|      RegionsTable = get_regions_table(GalaxyId),</font>
<font color=red>     0..|  	{ok, Regions} = read_all_records(RegionsTable),</font>
<font color=red>     0..|  	Results = [region_consistency_fix(GalaxyId, Region) || Region &lt;- Regions],</font>
<font color=red>     0..|  	{ok, Results}.</font>
        |  
        |  region_consistency_fix(GalaxyId, Region) -&gt;
<font color=red>     0..|  	SystemNames = Region#region.systems,</font>
<font color=red>     0..|  	purge_non_existing_systems_from_region(GalaxyId, Region, SystemNames).</font>
        |  
        |  purge_non_existing_systems_from_region(GalaxyId, PossibleUpdatedRegion, []) -&gt;
<font color=red>     0..|  	RegionsTable = get_regions_table(GalaxyId),</font>
<font color=red>     0..|  	T = fun() -&gt;</font>
<font color=red>     0..|  		mnesia:write(RegionsTable, PossibleUpdatedRegion, write)</font>
        |  	end,
<font color=red>     0..|  	case mnesia:transaction(T) of</font>
<font color=red>     0..|  		{atomic, ok} -&gt; {consistency_fixed_on_region, PossibleUpdatedRegion#region.name};</font>
<font color=red>     0..|  		Error -&gt; {consistency_failed_on_region, PossibleUpdatedRegion#region.name, Error}</font>
        |  	end;
        |  	
        |  purge_non_existing_systems_from_region(GalaxyId, Region, [SystemName | SystemsNames]) -&gt;
<font color=red>     0..|  	case system_exists(GalaxyId, SystemName) of</font>
        |  		true -&gt; 
<font color=red>     0..|  			pass;</font>
        |  		false -&gt;
<font color=red>     0..|  			SystemList = Region#region.systems,</font>
<font color=red>     0..|  			UpdatedSystemList = lists:delete(SystemName, SystemList),</font>
<font color=red>     0..|  			UpdatedRegion = Region#region{systems = UpdatedSystemList},</font>
<font color=red>     0..|  			purge_non_existing_systems_from_region(GalaxyId, UpdatedRegion, SystemsNames)</font>
        |  	end.
        |  
        |  
        |  read_galaxy(GalaxyId) -&gt;
<font color=red>     0..|  	T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:read(?DB_GALAXY_TABLE, GalaxyId)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, [Galaxy]} -&gt;
<font color=red>     0..|              {ok, Galaxy};</font>
        |  		{atomic, []} -&gt;
<font color=red>     0..|              {error, not_found};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  create_galaxy(Galaxy, _State) -&gt; 
<font color=red>     0..|      create_galaxy_tables(Galaxy#galaxy.id),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:write(?DB_GALAXY_TABLE, Galaxy, write)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, galaxy_created};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  update_galaxy(Galaxy, _State) -&gt; 
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:write(?DB_GALAXY_TABLE, Galaxy, write)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, galaxy_updated};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  destroy_galaxy(GalaxyId, _State) -&gt;
<font color=red>     0..|  	destroy_galaxy_tables(GalaxyId),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:delete(?DB_GALAXY_TABLE, GalaxyId, write)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, galaxy_destroyed};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  get_galaxy(GalaxyId, _State) -&gt;
<font color=red>     0..|  	read_galaxy(GalaxyId).</font>
        |  
        |  get_galaxies(_State) -&gt;
<font color=red>     0..|      Iterator = fun(Record, Acc) -&gt; lists:append(Acc, [Record]) end,</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:foldl(Iterator, [], ?DB_GALAXY_TABLE)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, AllGalaxies} -&gt;
<font color=red>     0..|              {ok, AllGalaxies};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  create_region(Region = #region{}, _State) -&gt;
<font color=red>     0..|      GalaxyId = Region#region.galaxy_id,</font>
<font color=red>     0..|      RegionTable = get_regions_table(GalaxyId),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:write(RegionTable, Region, write)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, region_created};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end;
        |  
        |  create_region(_Region, _State) -&gt;
<font color=red>     0..|      {error, bad_region_record}.</font>
        |  
        |  add_region_to_galaxy_record(GalaxyId, RegionName, State) -&gt;
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          [Galaxy] = mnesia:read(?DB_GALAXY_TABLE, GalaxyId, read),</font>
<font color=red>     0..|          case lists:member(RegionName, Galaxy#galaxy.regions) of</font>
        |          	true -&gt;
<font color=red>     0..|              	pass;</font>
        |              false -&gt;
<font color=red>     0..|              	MergedRegions = lists:merge(Galaxy#galaxy.regions, [RegionName]),</font>
<font color=red>     0..|                  mnesia:write(?DB_GALAXY_TABLE, Galaxy#galaxy{regions=MergedRegions}, write)</font>
        |              end
        |       end,
<font color=red>     0..|       case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, region_added};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  get_regions(GalaxyId, _State) -&gt;
<font color=red>     0..|      RegionsTable = get_regions_table(GalaxyId),</font>
<font color=red>     0..|      read_all_records(RegionsTable).</font>
        |  
        |  get_region(GalaxyId, RegionName, _State) -&gt;
<font color=red>     0..|      RegionsTable = get_regions_table(GalaxyId),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:read(RegionsTable, RegionName)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, []} -&gt;
<font color=red>     0..|              {error, region_not_found};</font>
        |          {atomic, [Region]} -&gt;
<font color=red>     0..|              {ok, Region};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  create_system(System = #system{}, _State) -&gt;
<font color=red>     0..|      SystemsTable = get_systems_table(System#system.galaxy_id),</font>
<font color=red>     0..|      RegionsTable = get_regions_table(System#system.galaxy_id),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          [Region] = mnesia:read(RegionsTable, System#system.region),</font>
<font color=red>     0..|          mnesia:write(SystemsTable, System, write),</font>
        |  		
        |  		
<font color=red>     0..|          mnesia:write(RegionsTable, Region#region{systems=lists:append(</font>
        |              Region#region.systems, [System#system.name])}, write)
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, system_created};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end;
        |  
        |  create_system(_System, _State) -&gt;
<font color=red>     0..|      {error, bad_system_record}.</font>
        |  
        |  remove_system(GalaxyId, SystemName, _State) -&gt;
<font color=red>     0..|  	SystemsTable = get_systems_table(GalaxyId),</font>
<font color=red>     0..|  	RegionsTable = get_regions_table(GalaxyId),</font>
<font color=red>     0..|  	T = fun() -&gt;</font>
<font color=red>     0..|  		[System] = mnesia:read(SystemsTable, SystemName, read),	</font>
<font color=red>     0..|  		[Region] = mnesia:read(RegionsTable, System#system.region),</font>
<font color=red>     0..|          mnesia:delete(SystemsTable, SystemName, write),</font>
<font color=red>     0..|  		RegionSystems = Region#region.systems,</font>
<font color=red>     0..|  		UpdatedRegionSystems = lists:delete(System#system.name, RegionSystems),</font>
<font color=red>     0..|          mnesia:write(RegionsTable, Region#region{systems=UpdatedRegionSystems}, write)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, system_removed};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  get_systems(GalaxyId, _State) -&gt;
<font color=red>     0..|      SystemsTable = get_systems_table(GalaxyId),</font>
<font color=red>     0..|      read_all_records(SystemsTable).</font>
        |  
        |  get_system(GalaxyId, SystemName, _State) -&gt;
<font color=red>     0..|      SystemsTable = get_systems_table(GalaxyId),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:read(SystemsTable, SystemName)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, [System]} -&gt;
<font color=red>     0..|              {ok, System};</font>
        |          {aborted, _Reason} -&gt;
<font color=red>     0..|              {error, system_not_found}</font>
        |      end.
        |  
        |  system_exists(GalaxyId, SystemName) -&gt;
<font color=red>     0..|      system_exists(GalaxyId, SystemName, undefined).</font>
        |  
        |  system_exists(GalaxyId, SystemName, _State) -&gt;
<font color=red>     0..|      SystemsTable = get_systems_table(GalaxyId),</font>
<font color=red>     0..|      case mnesia:dirty_read(SystemsTable, SystemName) of</font>
<font color=red>     0..|          [_Record] -&gt; true;</font>
<font color=red>     0..|          [] -&gt; false</font>
        |      end.
        |  
        |  connect_system(GalaxyId, OriginSystem, DestinationSystem, _State) -&gt;
<font color=red>     0..|  	SystemsTable = get_systems_table(GalaxyId),</font>
<font color=red>     0..|  	T = fun() -&gt;</font>
<font color=red>     0..|          [System] = mnesia:read(SystemsTable, OriginSystem),</font>
<font color=red>     0..|  		case lists:member(DestinationSystem, System#system.routes) of</font>
        |  			true -&gt;
<font color=red>     0..|  				ok;</font>
        |  			false -&gt;
<font color=red>     0..|  				mnesia:write(SystemsTable, System#system{routes=lists:append(</font>
        |              		System#system.routes, [DestinationSystem])}, write)
        |  		end
        |  	end,
<font color=red>     0..|  	case mnesia:transaction(T) of</font>
        |  		{atomic, ok} -&gt;
<font color=red>     0..|  			{ok, system_connected};</font>
        |  		{aborted, Reason} -&gt;
<font color=red>     0..|  			{error, Reason}</font>
        |  	end.
        |  
        |  disconnect_system(GalaxyId, OriginSystem, DestinationSystem, _State) -&gt;
<font color=red>     0..|  	SystemsTable = get_systems_table(GalaxyId),</font>
<font color=red>     0..|  	T = fun() -&gt;</font>
<font color=red>     0..|          [System] = mnesia:read(SystemsTable, OriginSystem),</font>
<font color=red>     0..|  		case lists:member(DestinationSystem, System#system.routes) of</font>
        |  			true -&gt;
<font color=red>     0..|  				mnesia:write(SystemsTable, System#system{routes=lists:delete(</font>
        |              		DestinationSystem, System#system.routes)}, write);
        |  			false -&gt;
<font color=red>     0..|  				ok</font>
        |  		end
        |  	end,
<font color=red>     0..|  	case mnesia:transaction(T) of</font>
        |  		{atomic, ok} -&gt;
<font color=red>     0..|  			{ok, system_disconnected};</font>
        |  		{aborted, Reason} -&gt;
<font color=red>     0..|  			{error, Reason}</font>
        |  	end.
        |  
        |  create_planet(Planet = #planet{}, _State) -&gt;
<font color=red>     0..|      SystemsTable = get_systems_table(Planet#planet.galaxy_id),</font>
<font color=red>     0..|      PlanetsTable = get_planets_table(Planet#planet.galaxy_id),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          [System] = mnesia:read(SystemsTable, Planet#planet.system),</font>
<font color=red>     0..|          mnesia:write(PlanetsTable, Planet, write),</font>
<font color=red>     0..|          mnesia:write(SystemsTable, System#system{planets=lists:append(</font>
        |              System#system.planets, [Planet#planet.name])}, write)
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, planet_created};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  update_planet(Planet = #planet{}, _State) -&gt;
<font color=red>     0..|      PlanetsTable = get_planets_table(Planet#planet.galaxy_id),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:write(PlanetsTable, Planet, write)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, planet_updated};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  get_planet(GalaxyId, PlanetName, _State) -&gt;
<font color=red>     0..|      PlanetsTable = get_planets_table(GalaxyId),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:read(PlanetsTable, PlanetName)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, [Planet]} -&gt;
<font color=red>     0..|              {ok, Planet};</font>
        |          {aborted, _Reason} -&gt;
<font color=red>     0..|              {error, planet_not_found}</font>
        |      end.
        |  
        |  create_resource_type(ResourceType, _State) -&gt;
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:write(?DB_RESOURCE_TYPE_TABLE, ResourceType, write)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, resource_type_created};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  get_resource_type(ResourceName, _State) -&gt;
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:read(?DB_RESOURCE_TYPE_TABLE, ResourceName)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, [ResourceType]} -&gt;
<font color=red>     0..|              {ok, ResourceType};</font>
        |          {atomic, []} -&gt;
<font color=red>     0..|              {error, not_found};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  create_structure_type(StructureType, _State) -&gt;
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:write(?DB_STRUCTURE_TYPE_TABLE, StructureType, write)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, structure_type_created};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  get_structure_type(StructureName, _State) -&gt;
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:read(?DB_STRUCTURE_TYPE_TABLE, StructureName)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, [StructureType]} -&gt;
<font color=red>     0..|              {ok, StructureType};</font>
        |          {aborted, _Reason} -&gt;
<font color=red>     0..|              {error, planet_not_found}</font>
        |      end.
        |  
        |  get_resource(GalaxyId, LinkId, planet, Resource, _State) -&gt;
<font color=red>     0..|      PlanetsTable = get_planets_table(GalaxyId),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:read(PlanetsTable, LinkId)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, [Planet]} -&gt;
<font color=red>     0..|              case lists:keysearch(Resource#resource.name, 1,</font>
        |                      Planet#planet.resources) of
        |                  {ok, {_ResourceName, Amount}} -&gt;
<font color=red>     0..|                      {ok, Amount};</font>
        |                  false -&gt;
<font color=red>     0..|                      {error, resource_not_found}</font>
        |              end;
        |          {aborted, _Reason} -&gt;
<font color=red>     0..|              {error, planet_not_found}</font>
        |      end;
        |  
        |  get_resource(_GalaxyId, _LinkId, _BadLinkType , _Resource, _State) -&gt;
<font color=red>     0..|      {error, bad_link_type}.</font>
        |  
        |  add_resource(GalaxyId, LinkId, planet, Resource, _State) -&gt;
<font color=red>     0..|      PlanetsTable = get_planets_table(GalaxyId),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          [Planet] = mnesia:read(PlanetsTable, LinkId),</font>
<font color=red>     0..|          mnesia:write(PlanetsTable, Planet#planet{resources=lists:append(</font>
        |              Planet#planet.resources, [Resource])}, write)
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, resource_added};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end;
        |  
        |  add_resource(_GalaxyId, _LinkId, _BadLinkType , _Resource, _State) -&gt;
<font color=red>     0..|      {error, bad_link_type}.</font>
        |  
        |  add_structure(GalaxyId, Structure, LinkId, planet, _State) -&gt;
<font color=red>     0..|      PlanetsTable = get_planets_table(GalaxyId),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          [Planet] = mnesia:read(PlanetsTable, LinkId),</font>
<font color=red>     0..|          mnesia:write(PlanetsTable, Planet#planet{structures=lists:append(</font>
        |              Planet#planet.structures, [Structure])}, write)
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, structure_added};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end;
        |  
        |  add_structure(GalaxyId, Structure, LinkId, system, _State) -&gt;
<font color=red>     0..|      SystemsTable = get_systems_table(GalaxyId),</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          [System] = mnesia:read(SystemsTable, LinkId),</font>
<font color=red>     0..|          mnesia:write(SystemsTable, System#system{structures=lists:append(</font>
        |              System#system.structures, [Structure])}, write)
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, ok} -&gt;
<font color=red>     0..|              {ok, structure_added};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end;
        |  
        |  add_structure(_GalaxyId, _Structure, _LinkId, _BadLinkType, _State) -&gt;
<font color=red>     0..|      {error, bad_link_type}.</font>
        |  
        |  get_regions_table(GalaxyId) -&gt;
<font color=red>     0..|      list_to_atom(binary_to_list(GalaxyId) ++ "_regions").</font>
        |  
        |  get_systems_table(GalaxyId) -&gt;
<font color=red>     0..|      list_to_atom(binary_to_list(GalaxyId) ++ "_systems").</font>
        |  
        |  get_planets_table(GalaxyId) -&gt;
<font color=red>     0..|      list_to_atom(binary_to_list(GalaxyId) ++ "_planets").</font>
        |  
        |  read_all_records(Table) -&gt;
<font color=red>     0..|      Iterator = fun(Record, Acc) -&gt; lists:append(Acc, [Record]) end,</font>
<font color=red>     0..|      T = fun() -&gt;</font>
<font color=red>     0..|          mnesia:foldl(Iterator, [], Table)</font>
        |      end,
<font color=red>     0..|      case mnesia:transaction(T) of</font>
        |          {atomic, AllRecords} -&gt;
<font color=red>     0..|              {ok, AllRecords};</font>
        |          {aborted, Reason} -&gt;
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  
</pre>
</body>
</html>
